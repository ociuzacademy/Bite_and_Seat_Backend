{% extends 'adminapp/dashboard.html' %}
{% load static %}

{% block content %}
<style>
    /* Scanner container styling */
    .scanner-container {
        max-width: 800px;
        margin: 0 auto;
        background: #ffffff;
        border-radius: 40px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.7s ease-in-out;
        color: #00477d; /* Default text color */
    }

    .scanner-container::before {
        content: "";
        position: absolute;
        height: 40%;
        width: 100%;
        background-color: #00477d;
        bottom: 0;
        right: 0;
        transform: translatey(70px);
        border-radius: 100%;
        transition: all 0.7s ease-in-out;
        z-index: 1;
    }

    .scanner-container:hover::before {
        transform: scale(7) translate(-20px);
    }

    .scanner-container:hover {
        color: white !important;
    }

    .scanner-content {
        position: relative;
        z-index: 2;
        transition: color 0.3s ease;
    }

    .scanner-container:hover .scanner-content {
        color: white !important;
    }

    /* Scanner box styling */
    #reader {
        width: 100%;
        max-width: 500px;
        margin: 20px auto;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        position: relative;
        z-index: 2;
    }

    /* Manual form styling */
    .manual-form-card {
        background: #ffffff;
        border-radius: 30px;
        padding: 25px;
        margin: 20px auto;
        max-width: 600px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        color: #00477d;
    }

    .manual-form-card::before {
        content: "";
        position: absolute;
        height: 30%;
        width: 100%;
        background-color: #00477d;
        bottom: 0;
        right: 0;
        transform: translatey(50px);
        border-radius: 100%;
        transition: all 0.7s ease-in-out;
        z-index: 1;
    }

    .manual-form-card:hover::before {
        transform: scale(5) translate(-15px);
    }

    .manual-form-card:hover {
        color: white !important;
    }

    .manual-form-card .form-content {
        position: relative;
        z-index: 2;
        transition: color 0.3s ease;
    }

    .manual-form-card:hover .form-content {
        color: white !important;
    }

    /* Order details card */
    .order-details-card {
        background: #ffffff;
        border-radius: 30px;
        padding: 25px;
        margin: 20px auto;
        max-width: 700px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        color: #00477d;
    }

    .order-details-card::before {
        content: "";
        position: absolute;
        height: 40%;
        width: 100%;
        background-color: #4CAF50;
        bottom: 0;
        right: 0;
        transform: translatey(60px);
        border-radius: 100%;
        transition: all 0.7s ease-in-out;
        z-index: 1;
    }

    .order-details-card:hover::before {
        transform: scale(6) translate(-20px);
    }

    .order-details-card:hover {
        color: white !important;
    }

    .order-details-content {
        position: relative;
        z-index: 2;
        transition: color 0.3s ease;
    }

    .order-details-card:hover .order-details-content {
        color: white !important;
    }

    /* Button styling */
    .scanner-btn {
        background: #00477d;
        color: white;
        padding: 12px 25px;
        border-radius: 25px;
        border: none;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 5px;
        position: relative;
        z-index: 3;
    }

    .scanner-btn:hover {
        background: #003366;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .scanner-btn-secondary {
        background: #6c757d;
    }

    .scanner-btn-secondary:hover {
        background: #5a6268;
    }

    /* Form input styling */
    .form-input-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
    }

    .form-input {
        flex: 1;
        padding: 12px 15px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 16px;
        transition: all 0.3s ease;
        background: white;
        color: #333;
        position: relative;
        z-index: 3;
    }

    .form-input:focus {
        outline: none;
        border-color: #00477d;
        box-shadow: 0 0 0 3px rgba(0, 71, 125, 0.1);
    }

    /* Status indicators */
    .status-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 14px;
        display: inline-block;
        position: relative;
        z-index: 3;
    }

    .status-paid {
        background: #4CAF50;
        color: white;
    }

    .status-pending {
        background: #f44336;
        color: white;
    }

    /* Result container */
    #result-container {
        background: #ffffff;
        border-radius: 20px;
        padding: 20px;
        margin: 20px auto;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        display: none;
        position: relative;
        z-index: 2;
    }

    /* Grid layout for order details */
    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }

    .detail-item {
        background: rgba(255, 255, 255, 0.9);
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        position: relative;
        z-index: 3;
        color: #333;
    }

    .scanner-container:hover .detail-item,
    .manual-form-card:hover .detail-item,
    .order-details-card:hover .detail-item {
        color: #333 !important; /* Keep detail items dark for readability */
    }

    /* Heading styling */
    .section-heading {
        color: #00477d;
        text-align: center;
        margin-bottom: 25px;
        font-weight: 600;
        position: relative;
        z-index: 3;
        transition: color 0.3s ease;
    }

    .scanner-container:hover .section-heading,
    .manual-form-card:hover .section-heading {
        color: white !important;
    }

    .success-heading {
        color: #00477d;
        position: relative;
        z-index: 3;
        transition: color 0.3s ease;
    }

    .order-details-card:hover .success-heading {
        color: white !important;
    }

    /* Success icon */
    .success-icon {
        background: #4CAF50;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        margin-bottom: 15px;
        position: relative;
        z-index: 3;
    }

    /* Responsive design */
    @media (max-width: 768px) {
        .scanner-container,
        .manual-form-card,
        .order-details-card {
            border-radius: 25px;
            padding: 20px;
            margin: 15px;
        }
        
        .form-input-group {
            flex-direction: column;
        }
        
        #reader {
            max-width: 300px;
        }
        
        .details-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<div class="container-fluid" style="color: #0e8097;">
    <h2 class="mb-4">QR Code Scanner</h2>
    
    <!-- Scanner Section -->
    <div class="scanner-container">
        <div class="scanner-content">
            <h3 class="section-heading">ðŸ“· Scan QR Code</h3>
            <div id="reader"></div>
            
            <div id="result-container">
                <h4>âœ… Scan Result:</h4>
                <div id="result-text">Waiting for QR scan...</div>
            </div>
        </div>
    </div>

    <!-- Manual Entry Section -->
    <div class="manual-form-card">
        <div class="form-content">
            <h3 class="section-heading">Or Enter Order ID Manually</h3>
            <form method="POST" action="/adminapp/scan-qr/">
                {% csrf_token %}
                <div class="form-input-group">
                    <input type="number" name="order_id" placeholder="Enter Order ID" class="form-input" min="1" required>
                    <button type="submit" class="scanner-btn">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Section -->
    {% if order_details %}
    <div class="order-details-card">
        <div class="order-details-content">
            <div class="text-center mb-4">
                <div class="success-icon">
                    âœ“
                </div>
                <h3 class="success-heading">Order Completed Successfully</h3>
                <p>QR Scan Successful</p>
            </div>

            <div class="details-grid">
                <div class="detail-item">
                    <p><strong>Order ID:</strong> #{{ order_details.id }}</p>
                    <p><strong>Booking Type:</strong> {{ order_details.booking_type }}</p>
                    <p><strong>Customer:</strong> {{ order_details.user }}</p>
                    <p><strong>Date:</strong> {{ order_details.date }}</p>
                </div>
                <div class="detail-item">
                    <p><strong>Total Amount:</strong> â‚¹{{ order_details.total_amount }}</p>
                    <p>
                        <strong>Table Payment:</strong><br>
                        <span class="status-badge {% if order_details.table_payment_status == 'paid' %}status-paid{% else %}status-pending{% endif %}">
                            {{ order_details.table_payment_mode|upper }} ({{ order_details.table_payment_status|upper }})
                        </span>
                    </p>
                    <p>
                        <strong>Food Payment:</strong><br>
                        <span class="status-badge {% if order_details.food_payment_status == 'paid' %}status-paid{% else %}status-pending{% endif %}">
                            {{ order_details.food_payment_mode|upper }} ({{ order_details.food_payment_status|upper }})
                        </span>
                    </p>
                </div>
            </div>

            <div class="mt-3 text-center">
                <a href="{% url 'admin_order_detail' order_details.id %}" class="btn btn-primary">
                    <i class="fas fa-eye"></i> View Full Order Details
                </a>
                {% if order.booking_type == 'TABLE_ONLY' %}
                <a href="{% url 'admin_add_food_to_order' order_details.id %}" class="btn btn-success">
                    <i class="fas fa-utensils"></i> Order Food
                </a>
                {% endif %}
                <button onclick="location.reload()" class="btn" style="background: #ffc107; color: white; border: 2px solid #ffc107;">
                    <i class="fas fa-redo"></i> Scan Another QR
                </button>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Hidden form for QR data submission -->
<form id="qrForm" method="POST" action="/adminapp/scan-qr/" style="display: none;">
    {% csrf_token %}
    <input type="hidden" name="qr_data" id="qrDataInput">
</form>

<!-- QR Scanner Script -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
    const html5QrCode = new Html5Qrcode("reader");

    function extractOrderId(text) {
        // Try JSON first
        try {
            const json = JSON.parse(text);
            if (json.order_id) return json.order_id;
        } catch (e) {
            // Ignore JSON errors
        }

        // Fallback for non-JSON formats
        const match = text.match(/order[_\s]*id\s*[:=]\s*(\d+)/i);
        if (match) return match[1];

        return null;
    }

    function onScanSuccess(decodedText) {
        const resultContainer = document.getElementById("result-container");
        const resultText = document.getElementById("result-text");

        resultContainer.style.display = "block";
        resultText.innerText = ` Text: ${decodedText}`;

        const orderId = extractOrderId(decodedText);

        if (orderId) {
            console.log("Order ID:", orderId);
            html5QrCode.stop();

            setTimeout(() => {
                const qrForm = document.getElementById('qrForm');
                const qrDataInput = document.getElementById('qrDataInput');
                qrDataInput.value = decodedText;
                qrForm.submit();
            }, 1000);
        } else {
            console.warn("order_id not found in scanned data");
        }
    }

    function onScanError(errorMessage) {
        // Ignore repetitive scan errors
    }

    // Start scanner
    html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        onScanSuccess,
        onScanError
    ).catch(err => {
        const resultText = document.getElementById("result-text");
        document.getElementById("result-container").style.display = "block";
        resultText.innerText = `Camera start failed: ${err}`;
    });
</script>

{% endblock %}